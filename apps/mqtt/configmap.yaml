apiVersion: v1
kind: ConfigMap
metadata:
  name: mqtt-config
  labels:
    app: mqtt
data:
  emqx.conf: |
    node.data_dir = "/opt/emqx/data"
    node.db_backend = "mnesia"

    log.console.enable = true
    log.console.level = warning

    cluster.discovery_strategy = "k8s"
    cluster.k8s.apiserver = "https://kubernetes.default.svc:443"
    cluster.k8s.service_name = "mqtt-headless"
    cluster.k8s.address_type = "hostname"
    cluster.k8s.namespace = "default"
    cluster.k8s.suffix = "svc.cluster.local"

    authentication = [{
      backend = redis
      redis_type = single
      server = "127.0.0.1:6379"
      password = "${REDIS_PASSWORD}"
      cmd = "HMGET mqtt:${username} password_hash salt"
      database = 0
      enable = true
      mechanism = password_based
      password_hash_algorithm.name = sha256
      password_hash_algorithm.salt_position = prefix
      pool_size = 8
    }]

    authorization.deny_action = "ignore"
    authorization.no_match = "allow"
    authorization.sources = [{
      type = "file"
      enable = true
      path = "/opt/emqx/etc/acl.conf"
    }]

    listeners.ssl.default.enabled = false
    listeners.ws.default.enabled = false
    listeners.wss.default.enabled = false

    dashboard.default_username = "markis"
    dashboard.listeners.http.bind = "0.0.0.0:18083"
    dashboard.listeners.http.max_connections = 512

  acl.conf: |
    {allow, all}.

  load-users.sh: |
    #!/bin/sh
    set -e

    # Wait for Redis to be ready
    until redis-cli ping >/dev/null 2>&1; do
      echo "Waiting for Redis..."
      sleep 0.5
    done

    echo "Redis is ready, loading users..."

    # Read users file (format: username:password per line)
    while IFS=: read -r username password || [ -n "$username" ]; do
      # Skip empty lines and comments
      [ -z "$username" ] && continue
      echo "$username" | grep -q '^#' && continue

      # Generate random 16-byte salt (hex encoded)
      salt=$(head -c 16 /dev/urandom | od -An -tx1 | tr -d ' \n')

      # Hash: SHA256(salt + password), output as hex
      password_hash=$(printf '%s%s' "$salt" "$password" | sha256sum | cut -d' ' -f1)

      # Store in Redis: HSET mqtt:<username> password_hash <hash> salt <salt>
      redis-cli HSET "mqtt:${username}" password_hash "$password_hash" salt "$salt"
      echo "Loaded user: $username"
    done < /opt/users.txt

    echo "All users loaded successfully"
