# =============================================================================
# Infrastructure Applications
# =============================================================================
# This file defines all infrastructure/platform components deployed via ArgoCD.
# Each app entry generates an ArgoCD Application CRD.
#
# To add a new infrastructure component:
#   1. Add a new entry to the apps list below
#   2. Specify the Helm chart repository, chart name, and version
#   3. Add any custom values under the 'values' key
# =============================================================================

infra:
  # ===========================================================================
  # ArgoCD - GitOps Continuous Delivery
  # ===========================================================================
  # ArgoCD manages itself! This is a common pattern where ArgoCD deploys and
  # updates its own installation.
  # Helm Chart: https://github.com/argoproj/argo-helm/tree/main/charts/argo-cd
  # ===========================================================================
  - name: argocd
    namespace: argocd
    repoURL: https://argoproj.github.io/argo-helm
    chart: argo-cd
    targetRevision: 7.7.12
    serverSideApply: true
    ignoreDifferences:
      - group: apps
        kind: Deployment
        jsonPointers:
          - /spec/replicas
    values: |
      global:
        additionalLabels:
          app.kubernetes.io/part-of: argocd
      dex:
        certificateSecret:
          enabled: false
      server:
        replicas: 1
        ingress:
          enabled: false
      controller:
        replicas: 1
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
      repoServer:
        replicas: 1
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi
      redis:
        enabled: true
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 64Mi
      applicationSet:
        enabled: true
        replicas: 1
      notifications:
        enabled: true

  # ===========================================================================
  # 1Password Connect - Secrets Automation
  # ===========================================================================
  # 1Password Connect provides a secure way to access 1Password items from
  # your infrastructure. It runs a local API server that integrates with
  # Kubernetes to inject secrets from 1Password vaults.
  #
  # IMPORTANT: You must create secrets before deploying:
  #   kubectl create secret generic op-credentials \
  #     --from-file=1password-credentials.json -n 1password
  #   kubectl create secret generic onepassword-token \
  #     --from-literal=token=<your-token> -n 1password
  #
  # Helm Chart: https://github.com/1Password/connect-helm-charts
  # ===========================================================================
  - name: 1password-connect
    namespace: 1password
    repoURL: https://1password.github.io/connect-helm-charts
    chart: connect
    targetRevision: 1.17.0
    values: |
      connect:
        create: true
        replicas: 1
        credentialsName: op-credentials
        credentialsKey: 1password-credentials.json
        serviceType: ClusterIP
        api:
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
      operator:
        create: true
        replicas: 1
        token:
          name: onepassword-token
          key: token
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi

  # ===========================================================================
  # cert-manager - Automatic TLS Certificate Management
  # ===========================================================================
  # cert-manager adds certificates and certificate issuers as resource types
  # in Kubernetes clusters, and simplifies the process of obtaining, renewing
  # and using those certificates.
  #
  # Helm Chart: https://github.com/cert-manager/cert-manager
  # ===========================================================================
  - name: cert-manager
    namespace: cert-manager
    repoURL: https://charts.jetstack.io
    chart: cert-manager
    targetRevision: v1.16.2
    serverSideApply: true
    ignoreDifferences:
      - group: admissionregistration.k8s.io
        kind: ValidatingWebhookConfiguration
        jsonPointers:
          - /webhooks/0/clientConfig/caBundle
      - group: admissionregistration.k8s.io
        kind: MutatingWebhookConfiguration
        jsonPointers:
          - /webhooks/0/clientConfig/caBundle
    values: |
      crds:
        enabled: true
        keep: true
      replicaCount: 1
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi
      webhook:
        replicaCount: 1
        resources:
          limits:
            cpu: 50m
            memory: 64Mi
          requests:
            cpu: 25m
            memory: 32Mi
      cainjector:
        replicaCount: 1
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
      prometheus:
        enabled: false
        servicemonitor:
          enabled: false
      global:
        logLevel: 2
        leaderElection:
          namespace: cert-manager

  # ===========================================================================
  # Traefik - Cloud Native Ingress Controller
  # ===========================================================================
  # Traefik is a modern HTTP reverse proxy and load balancer that makes
  # deploying microservices easy. It integrates with Kubernetes Ingress
  # and provides automatic TLS certificate management.
  #
  # Helm Chart: https://github.com/traefik/traefik-helm-chart
  # ===========================================================================
  - name: traefik
    namespace: traefik
    repoURL: https://traefik.github.io/charts
    chart: traefik
    targetRevision: 33.2.1
    values: |
      deployment:
        replicas: 1
        annotations: {}
      service:
        type: LoadBalancer
        annotations: {}
      ports:
        web:
          port: 8000
          expose:
            default: true
          exposedPort: 80
          protocol: TCP
        websecure:
          port: 8443
          expose:
            default: true
          exposedPort: 443
          protocol: TCP
          tls:
            enabled: true
      providers:
        kubernetesIngress:
          enabled: true
          allowCrossNamespace: true
        kubernetesCRD:
          enabled: true
          allowCrossNamespace: true
      logs:
        general:
          level: INFO
        access:
          enabled: true
          format: json
      ingressRoute:
        dashboard:
          enabled: false
      resources:
        limits:
          cpu: 300m
          memory: 150Mi
        requests:
          cpu: 100m
          memory: 50Mi
      additionalArguments:
        - "--metrics.prometheus=true"
        - "--ping=true"

  # ===========================================================================
  # Monitoring Secrets - 1Password integration for Grafana
  # ===========================================================================
  # Deploys 1Password secrets for the monitoring stack. Must be deployed
  # before kube-prometheus-stack so the secret exists.
  # ===========================================================================
  - name: monitoring-secrets
    namespace: monitoring
    repoURL: https://github.com/markis/cluster-config.git
    path: infrastructure/monitoring-secrets
    targetRevision: HEAD

  # ===========================================================================
  # Prometheus + Grafana - Monitoring Stack
  # ===========================================================================
  # kube-prometheus-stack provides a complete monitoring solution including
  # Prometheus for metrics collection, Grafana for visualization, and
  # various exporters for Kubernetes metrics.
  #
  # Configured for lightweight operation on Raspberry Pi cluster.
  # Helm Chart: https://github.com/prometheus-community/helm-charts
  # ===========================================================================
  - name: kube-prometheus-stack
    namespace: monitoring
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 69.3.1
    serverSideApply: true
    ignoreDifferences:
      - group: admissionregistration.k8s.io
        kind: MutatingWebhookConfiguration
        jsonPointers:
          - /webhooks/0/clientConfig/caBundle
      - group: admissionregistration.k8s.io
        kind: ValidatingWebhookConfiguration
        jsonPointers:
          - /webhooks/0/clientConfig/caBundle
    values: |
      # Lightweight config for Raspberry Pi cluster
      prometheus:
        prometheusSpec:
          nodeSelector:
            workload/prometheus: "true"
          retention: 7d
          retentionSize: "8GB"
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          storageSpec:
            volumeClaimTemplate:
              spec:
                storageClassName: local-path
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 10Gi
      grafana:
        nodeSelector:
          workload/prometheus: "true"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        persistence:
          enabled: true
          storageClassName: local-path
          size: 1Gi
        admin:
          existingSecret: grafana-admin
          userKey: admin-user
          passwordKey: admin-password
        ingress:
          enabled: true
          ingressClassName: traefik
          hosts:
            - grafana.k3s.lan
        grafana.ini:
          server:
            root_url: http://grafana.k3s.lan
      alertmanager:
        enabled: false
      nodeExporter:
        resources:
          requests:
            cpu: 50m
            memory: 30Mi
          limits:
            cpu: 200m
            memory: 50Mi
      kube-state-metrics:
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi
      prometheusOperator:
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 200m
            memory: 200Mi
